name: Update README with Repo Status

on:
  workflow_call:
    inputs:
      default_branch:
        required: false
        type: string
        default: 'master'
jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get repo info
        id: repo-info
        uses: actions/github-script@v6
        with:
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const issues = await github.issues.listForRepo({ owner, repo, state: 'all' });
            const pulls = await github.pulls.list({ owner, repo, state: 'all' });
            const files = await github.repos.getContent({ owner, repo, path: '' });
            const contributors = await github.repos.listContributors({ owner, repo });
            return {
              issues: issues.data.length,
              pulls: pulls.data.length,
              files: files.data.length,
              contributors: contributors.data.map(c => c.login).slice(0, 5).join(', '),
              repo,
              owner
            };

      - name: Generate README
        run: |
          echo "[![CI](https://github.com/${{ github.repository }}/actions/workflows/validation.yml/badge.svg?branch=master)](https://github.com/${{ github.repository }}/actions/workflows/validation.yml)" > README.md
          echo "" >> README.md
          echo "# Repository Status" >> README.md
          echo "- Number of issues: ${{ steps.repo-info.outputs.issues }}" >> README.md
          echo "- Number of pull requests: ${{ steps.repo-info.outputs.pulls }}" >> README.md
          echo "- Number of files: ${{ steps.repo-info.outputs.files }}" >> README.md
          echo "- Major contributors: ${{ steps.repo-info.outputs.contributors }}" >> README.md

      - name: Commit and push README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m 'Update README with repo status'
            git push
